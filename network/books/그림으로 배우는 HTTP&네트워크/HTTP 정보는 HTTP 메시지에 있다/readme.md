HTTP 통신에는 클라이언트에서 서버로 보내는 리퀘스트와 서버에서 클라이언트에 보내는 리스폰스가 있다. 이 리퀘스트와 리스폰스가 어떻게 동작하는지 알아보도록 하자.

## 3.1 HTTP 메시지

HTTP에서 교환하는 정보는 HTTP 메시지라고 불리는데 리퀘스트측 HTTP메시지를 리퀘스트 메시지, 리스폰스측 HTTP메시지를 리스폰스 메시지라고 부른다. 
HTTP 메시지는 복수행의 데이터로 구성된 텍스트 문자열이다. HTTP메시지는 크게 구분하면 메시지헤더와 메시지 바디로 되어있고 최초에 나타나는 개행문자로 메시지 헤더와 메시지 바디를 구분한다. 이 안에 메시지 바디가 항상 존재한다고 할 수 없다. 

## 3.2 리퀘스트 메시지와리스폰스 메시지의 구조 

리퀘스트 메시지와 리스폰스 메시지 구조를 살펴보자.

- 리퀘스트 라인: 리퀘스트에 사용하는 메소드와 리퀘스트 URI와 사용하는 HTTP버전이 포함된다.
- 상태라인 : 리스폰스 결과를 나타내는 상태코드와 설명, 사용하는 HTTP버전이 포함된다. 
- 헤더필드: 리퀘스트와 리스폰스의 여러 조건과 속성등을 나타내는 각종 헤더 필드가 포함된다. 일반헤더필드, 리퀘스트 헤더필드, 리스폰스헤더필드, 엔티티 헤더필드등 4종류가 있다.

## 3.3 인코딩으로 전송 효율을 높이다.
HTTP로 데이터를 전송할 경우 그대로 전송할 수 있지만 전송할 때에 인코딩(변환)을 실시함으로써 전송 효율을 높일 수 있다.
전송할 때 인코딩을 하면 다량의 엑세스를 효율 좋게처리할 수 있다. 단지, 컴퓨터에서 인코딩 처리를 해야하기 때문에 CPU등의 리소스는 보다 많이 소비하게 된다.

### 3.3.1 메시지 바디와 엔티티 바디의 차이
- 메시지: HTTP 통신의 기본단위로 옥텟 시퀀스로 구성되고 통신을 통해서 전송된다.
- 엔티티: 리퀘스트랑 리스폰스의 페이로드(payload, 부가물)로 전송되는 정보로 엔티티 헤더 필드와 엔티티 바디로 구성된다.


HTTP메시지 바디의 역할은 리퀘스트랑 리스폰스에 관한 엔티티 바디를 운반하는 일이다. 기본적으로 메시지 바디와 엔티티 바디는 같지만 전송 코딩이 적용된 경우에는 엔티티 바디의 내용이 변화하기 때문에 메시지 바디와 달라진다. 메시지와 엔티티라는 단어는 뒤에서도 자주 등장하기 때문에 차이점을 이해해두자.


### 3.3.2 압축해서 보내는 콘텐츠 코딩
메일에 파일을 첨부해서 보낼 경우 같이 용량을 줄이기 위해서 파일을zip 으로 압축하고 나서 첨부해서 보내는 일이 있다. HTTP에는 이와 같은 일이 가능한 콘텐츠 코딩이라고 불리는 기능이 구현되어있다. 콘텐츠 코딩은 엔티티에 적용하는 인코딩을 가리키는데 엔티티 정보를 유지한채로 압축한다. 콘텐츠 코딩된 엔티티는 수신한 클라이언트 측에서 디코딩한다. 주요 콘텐츠 압축에는 다음과 같은 것이 있다.
- gzip(GNU zip)
- compress(UNIX 의 표준압축)
- deflate(zlib)
- identity(인코딩 없음)


### 3.3.3 분해해서 보내는 청크 전송 코딩

HTTP 통신에서는 리퀘스트했었던 리소스 전부에서 엔티티 바디의 전송이 완료되지 않으면 브라우저에 표시되지 않는다. 사이즈가 큰 데이터를 전송하는 경우에 데이터를 분할해서 조금씩 표시할 수 있다. 이렇게 엔티티 바디를 분할하는 기능을 청크전송코딩(Chunked transfer coding)이라고 한다.
청크 전송 코딩으 ㄴ엔티티 바디를 청크로 분해한다. 다음 청크사이즈를 16진수로 사용해서 단락을 표시하고 엔티티 바디 끝에는 0을 기록해둔다. 청크 전송 코딩된 엔티티 바디는 수신한 클라이언트측에서 원래의 엔티티 바디로 디코딩한다. http/1.1 에는 전송코딩이라는, 어떤 인코딩 방식에 따라서 전송하는 구조가 마련되어 있지만 전송코딩에는 청크 전송 코딩만 정의되어있다. 

## 3.4 여러 데이터를 보내는 멀티파트

메일의 경우에는 메일의 본문이나 복수의 첨부 파일을 붙여서 함께 보낼 수 있다. MIME(Multipurpose Internet Mail Extensions) 다목적 인터넷 메일 확장 사양 으로 불리는 메일로 텍스트나 영상 이미지와 같은 여러 데이터를 다루기 위한 기능을 사용하고 있다.

MIME은 이미지 등의 바이너리 데이터를 아스키 문자열에 인코딩하는 방법과 데이터 종류를 나타내는 방법등을 규정하고 있다. 이 MIME의 확장 사양에 있는 멀티파트라고 하는 여러 다른 종류의 데이터를 수용하는 방법을 사용하고 있는 것이다.

HTTP도 멀티파트에 대응하고 있어 하나의 메시지 바디 내부에 엔티티를 여러개 포함시켜 보낼 수 있다. 주로 이미지나 텍스트 파일등을 업로드할 때 사용된다.

- multipart/form-data
- multipart/byteranges: 상태코드 206 Partial Content 리스폰스 메시지가 복수 범위의 내용을 포함하는 때에 사용된다. 
- HTTP메시지로 멀티파트를 사용할 때에는 Content-type 헤더 필드를 사용해야한다.

멀티파트 각각의 엔티티를 구분하기위해 boundary 문자열을 사용한다. 각엔티티의 선두에는 boundary 문자열 앞에 --를 삽입한다. 멀티파트는 파트마다 헤더필드가 포함된다. 또한 파트의 중간에 멀티파트를 만드는 것과 같이 파트를 내부에포함할 수도 있다. 멀티파트에 대한 내용은 RFC2046 참고.

## 3.5 일부분만 받는 레인지 리퀘스트 

요즘처럼 사용자가 광대역의 네트워크를 이용할 수 있기전에는 대용량의 이미지와 데이터를 다운로드하기가 힘들었다.
왜냐하면 다운로드 중에 커넥션이 끊어지게 되면 처음부터 다시 다운로드를 해야했기 때문이다. 이러한 문제를 해결하기 위해서 일반적인 리줌이라는 기능이 필요하게 되었다. 리줌을 통해 이전에 다운로드 한 곳에서 부터 다운로드를 재개할 수 있다.

이기능을 실현하기 위해서는 엔티티의 범위를 지정해서 다운로드를 할 필요가 있다. 이와 같이 범위를 지정하여 리퀘스트 하는 것을 레인지 리퀘스트라고 부른다.

레인지 리퀘스트를 사용하면 전체 10000바이트 정도 크기의 리소스에서 5001~10000바이트범위 만을 레인지 리퀘스트 할 수 있다. 레인지 리퀘스트를 할 때에는  Range 헤더 필드를 사용해서 리소스의 바이트 레인지를 정한다.

- 처음부터 3000 바이트까지, 그리고 5000~ 7000 바이트까지 복수범위
`Range: bytes=-3000, 5000-7000`

레인지 리퀘스트에 대한 리스폰스 상태코드 206 PartialContent  라는 리스폰스 메시지가 돌아온다 또한, 복수 범위의 레인지 리퀘스트에 대한 리스폰스는 multipart/byteranges 로 리스폰스가 돌아온다. 서버가 레인지 리퀘스트에 지원하지 않는 경우에는 상태코드 200OK 라는 리스폰스 메시지로 완전한 엔티티가 돌아온다. 

## 3.6 최적의 콘텐츠를 돌려주는 콘텐츠 네고시에이션

같은 콘텐츠이지만 여러개의 페이지를 지닌 웹페이지가 있다. 예를들면, 내용은 같지만 영어판과 한국어판과 같이 표시되는 언어가 서로다른 웹페이지의 경우이다.
이러한 웹페이지에서는 영어와 한국어와 같이 서로다른 언어를 주로 사용하는 브라우저가 같은 URI에 엑세스할 때에 각각 영어판 웹페이지와 한국어판 웹페이지를 표시한다. 이와 같은 구조를 콘텐츠 네고시에이션 Content Negotiation 이라고 부른다.

콘텐츠 네고시에이션이란 클라이언트와 서버가 제공하는 리소스의 내용에 대해서 교섭하는 것이다. 클라이언트에 더욱 적합한 리소스를 제공하기 위한 구조이다.콘텐츠 네고시에이션은 제공하는 리소스를 제공하는 리소스를 언어와 문자세트, 인코딩 방식을 기준으로 판단한다. 판단 기준은 리퀘스트 메시지에 포함된 다음과 같은 리퀘스트헤더 필드이다. 

- Accept
- Accept-Charset
- Accept-Encoding
- Accept-Language
- Content-Language

콘텐츠 네고시에이션에는 다음과 같은 종류들이 있다.

- 서버 구동형 네고시에이션: 서버측에서 콘텐츠 네고시에이션을 하는 방법이다. 서버측에서 리퀘스트 헤더필드의 정보를 참고해서 자동적으로 처리를한다. 단지 브라우저가 보내는 정보를 근거롸기 때문에 유저에게 정말로 적절한 것이 선택되었다고 할 수는 없다.
- 에이전트 구동형 네고시에이션: 클라이언트 측에서 콘텐츠 네고시에이션을 하는 방식이다. 브라우저에 표시된 선택지중에서 유저가 수동으로 선택한다. js등을 사용해서 웹 페이지에서 자동적으로 이것을 정하는 것도 있다. 예를들면 os의 종류나 브라우저의 종류등에 의해서 PC용과 스마트폰용 웹페이지를 전환하는것이 이에 해당한다.
- 트랜스페어런트 네고시에이션 transpatent negotiation 서버 구동형과 에이전트 구동형을 혼합한 것으로 서버와 클라이언트가 콘텐츠 네고시에이션을 하는 방법.


