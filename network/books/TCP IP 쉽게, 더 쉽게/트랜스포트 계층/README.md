# 3장 트랜스포트 계층

컴퓨터 안까지 들어온 데이터를 각 프로그램까지 전달하는 것이 바로 트랜스포트 계층이다.
여러 컴퓨터로부터 받은 데이터를 트랜스포트 계층에서 분류한 후에 애플리케이션 계층의 프로그램에 전달하는데, 이때 사용되는 분류 기준이 포트 번호다. 트랜스포트 계층의 대표적인 프로토콜은 TCP, UDP두가지이다. TCP는 웹이나 이메일과 같이 데이터가 정확하게 전달되어야 하는 통신에 사용되고, UDP는 VoIP나 동영상 스트리밍과 같이 전송 속도가 빨라야하는 통신에 사용된다.
인터넷 기술을 언급할때 TCP/IP라는 용어가 대표적으로 사용될 만큼 TCP는 많이 활용되고 중요한 역할을 하고 있다. 간혹 TCP가 정보를 정확하게 전달한다고 하는데 왜 가끔 웹페이지가 표시되지 않거나 이메일이 제대로 전달되지 않냐고 의문을 제기할 수 있다. 하지만 이런 경우는 TCP만으로는 어떻게 처리하지 못하는 다른 문제 상황이 원인이라고 봐야한다. 실제로 TCP를 사용하지않고 UDP를 사용한다거나 인터넷 계층만 사용해서 통신을 할 경우, 거대한 인터넷망 안에서 데이터가 수신지까지 제대로 도달하지 못하고 유실되는 경우가 많다.

## 트랜스포트 계층의 역할

트랜스포트 계층의 역할은 수신지의 애플리케이션에 데이터를 전달하는 것이다. 트랜스포트 계층에서 사용하는 대표적인 프로토콜로는 전송의 신뢰성을 중시하는 TCP와 전송속도를 중시하는 UDP가 있다.

트랜스포트 계층은 애플리케이션 계층과 인터넷 계층 사이에 위치한다. 인터넷 계층의 역할이 데이터를 수신지 컴퓨터까지 전달하는 것이라면, 트랜스포트 계층의 역할은 컴퓨터가 받은 데이터를 애플리케이션까지 전달하는 것이다.
트랜스포트 계층의 TCP프로토콜은 수신지에 데이터가 정확하게 전달되도록 전송 속도를 조절하거나 도달하지 않은 데이터를 재전송한다.
수신지의 통신환경에 맞춰 데이터 크기를 정하거나 연속된 데이터를 몰아서 보낼 개수를 정한다. 수신지와 송신지가 받아낼수 있는 데이터 크기를 상의한다. 수신지는 도달하지 않은 패킷이있다면 재전송을 요청한다.
VoIP(인터넷 전화)나 동영상 스트리밍 서비스와 같이 실시간 통신이 필요하다면 전송속도를 중시하는 UDP 를 사용한다. UDP는 별다른 처리를 하지 않는 대신 전송 속도가 빠르다.

## 포트번호

데이터를 어떤 애플리케이션의 어느 프로토콜로 전달할지에 대해서는 프트번호를 보고 판단한다.
트랜스포트 계층에는 인터넷 계층에서 전달한 다양한 종류의 패킷이 들어온다. 이 패킷들은 애플리케이션 계층에 있는 애플리케이션들에게 각각 전달되어야 하는데, 이때 어느 애플리케이션으로 보내져야 할지는 포트 번호를 통해 알 수 있다. 트랜스포트 계층의 프로토콜들은 패킷의 포트번호를 보고 어느 애플리케이션으로 그 패킷을 전달해야 할지 알 수 있다.

## 포트 번호의 범위

포트 번호는 0~65535번까지 이용할 수 있고, 웰 노운 포트(well-known ports), 레지스터드 포트(registered ports), 다이나믹 포트(dynamic ports)의 세종류로 구분된다. 이중 웰노운 포트는 애플리케이션 계층에서 가장 많이 사용되는 대표적인 프로토콜의 수신 포트들이다.
well known port => 서버 프로그램이 수신 대기할 때 사용하는 포트
registered port => 벤더가 할당받아 사용하는 포트
dynamic port => 클라이언트 프로그램이 사용하는 포트
IANA라는 단체에서 위 포트들을 관리한다.

주요 well known port
20번 => FTP(액티브 모드에서는 데이터 커넥션, 패시브 모드에서는 랜덤포트를 사용함)
21번 => FTP(컨트롤 커넥션)
22번 => SSH(원격 제어, 보안기능 있음)
23번 => Telnet(원격 제어)
25번 => SMTP(이메일 전송)
80번 => HTTP(웹)
110번=> POP3(이메일 수신)
143번 => IMAP4(이메일 수신, 보관기능 있음)

클라이언트가 사용하는 포트 번호는 다이나믹 포트 번호 대역에서 자동으로 할당되기 때문에 어떤 번호가 사용될지는 미리 알 수 없다.

## 클라이언트와 서버의 접속이 완료되기까지의 과정

클라이언트와 서버가 서로 통신하기 위해서는 먼저 클라이언트가 사용할 포트를 결정하고 이후 서버의 포트에 접속하게 된다. HTTP 인 경우 서버측에서 수신 대기하는 포트 번호는 80번이다. 클라이언트인 웹 브라우저는 다이나믹 포트를 사용하기 때문에 포트 번호가 애당초에 정해져 있지 않다.
통신과정

1. 클라이언트 측 포트 번호 할당 , 웹서버는 80번 포트에서 대기중
2. 연결할 웹서버의 80번 포트에 접속 요청
3. 웹서버가 접속을 허용하면 통신 가능 상태가 된다.
4. 통신이 완료되면 발급된 다이나믹 포트를 반납한다.

서버측의 포트 번호는 고정되어 있기 때문에 여러 클라이언트가 서버와 통신하는 과정에서 같은 포트로 요청이 몰리게 된다. 서버는 수신 대기를 위해 같은 포트를 사용하는 반면, 접속을 요청한 클라이언트 측은 서로 다른 IP어드레스와 포트 번호를 사용한다. 서버는 이러한 클라이언트 IP어드레스와 포트 번호를 조합하여 클라이언트를 식별할 수 있기 때문에 여러 클라이언트와 통신하는 상황에서도 혼선이 발생하지 않는다.
(클라이언트의 IP주소와 포트번호를 조합해서 기억해둔다!!)

## TCP가 정확하게 데이터를 전달하는 방법

TCP에는 데이터를 정확하게 전달하기 위한 다양한 기법이 적용되어있다.
TCP(Transmission Control Protocol)는 트랜스포트 계층의 프로토콜의 하나로서 웹이나 이메일, FTP와 같이 정확한 데이터 전달이 필요한 통신에 사용된다. TCP는 데이터 전송에 신뢰성을 더하기 위해 데이터를 세그먼트라는 단위로 분할하고 전송속도를 조정하며, 데이터가 제대로 전달되지 않았을 경우 재전송을 하게 된다.
수신지와 통신 상태에 따라서 전송량을 조절한다. TCP에서는 분할된 데이터를 세그먼트라고 부른다. 또한 주고받은 바이트 수를 비교해서 차이가 있으면 재전송한다.
TCP의 세그먼트는 데이터 본체에 TCP헤더가 붙은 형태로 구성된다. TCP헤더에는 포트번호나 일련번호와 같은 정보가 포함된다.
일련번호(송신한 바이트 수) sequence number
확인 응답 번호(수신한 바이트 수 ) acknowledgment number
윈도우 사이즈(한번에 수신할 수 있는 데이터 크기) windows size
체크섬(checksum) 데이터가 훼손되었는지 확인하기 위한 정보

TCP헤더중 컨트롤 비트는 현재의 통신 상태를 표현하는 플래그 역할을 하며 통신 상대에게 이 정보를 전달해서 TCP통신을 제어하는 용도로 사용된다. 9개의 플래그 각각은 1비트 크기를 차징하여 ON/OFF두가지 상태를 관리한다.
CWR 통신 경로가 혼잡해서 전송량을 줄여줄 것을 알려준다.
ECE 통신 경로가 혼잡해서 수신할 수 없을 수도 있다는 것을 알려준다.
URG 긴급 포인터에서 지정한 데이터를 직접 처리해야 한다는 것을 알려준다.
ACK 이전 동작을 확인 했다는 것을 알려준다. 확인 응답 번호와 조합해서 사용된다.
PSH 수신 데이터를 즉시 애플리케이션 계층에 전달해야한다는 것을 알려준다.
RST 이상 상황이 발생하여 접속이 강제 중단되었다는 것을 알려준다.
SYN 접속을 시작할 때 ON으로 설정한다.
FIN 데이터 송신이 완료되어 통신을 종료하고 싶다는 것을 알려준다.

TCP통신은 커넥션 연결에서 시작한다. 커넥션을 맺는 과정은 3단계로 진행되기 때문에 이것을 3방향 핸드셰이크라고 부른다. 커넥션이 맺어지면 데이터를 전송할 수 있는 상태가 되고 데이터 전송이 끝나면 커넥션을 끊는다. 통신을 시작하고 싶을 때 SYN을 ON으로 설정하고 통신을 끝내고 싶을 때는 FIN을 ON으로 설정한다. ACK는 데이터가 잘 도착했는지 확인 응답을 하기 위한 플래그이다. ACK가 ON으로 설정된 패킷이 응답으로 돌아오지 않으면 제대로 전달되지 않은 것이라고 판단한다.
커넥션을 맺을 때 송신측과 수신측은 원할한 통신을 위해 사전에 일련번호와 최대 세그먼트 크기 (MSS, Maximum Segment Size)를 서로 합의하고 조율하는 과정을 거치게 된다.
커넥션을 맺는 과정에서 일련번호는 1씩 증가하는데, 데이터를 전송할 때는 여기에 전송한 데이터의 바이트 수만큼 더 더해진다. 또한 데이터를 수신한 후에는 수신한 데이터의 바이트 수만큼 확인 응답 번호에 더하기 때문에 일련번호와 확인 응답 번호를 확인하려면 몇 바이트의 데이터를 주고 받았는지 알 수 있다.
TCP는 일련번호와 응답확인 번호정보를 따로 관리하면서 데이터가 제대로 송수신되는지 확인한다.
인터넷에서 통신하다 보면 패킷 일부가 제대로 전달되지 않거나 패킷 자체는 전달 되었더라도 응답 패킷이 전달되지 않은 경우가 발생할 수 있다. 송신 측에서는 일정 시간이 지난 후에도 수신측으로 응답이 오지 않을 경우 송신 실패로 간주하고 최근에 정상적으로 응답을 받은 후부터 데이터를 재전송한다.
앞서 보낸 데이터에 대한 응답을 받은 후에 다음 데이터를 보내는 방식은 통신이 정상적으로 완료되기까지 많은 시간이 필요하다. 대신, 응답을 기다리지 않고 연속된 데이터를 몰아서 보내면 전송 속도를 더 빠르게 향상시킬 수 있다.
연속해서 몰아 보내는 데이터의 양이 너무 많으면 수신측이 제떄 처리하지 못할 수도있다. 그래서 수신측은 수신한 데이터를 일시적으로 보관할수있는 버퍼(Buffer)라는 저장 영역을 가지고 있다. 수신측은 TCP헤더의 윈도우 사이즈에 이 버퍼의 크기를 설정하고 송신측에 통보함으로써 어느 정도의 크기까지 받아 낼 수 있는 지를 알려주게 된다.
수신측은 도착한 패킷들을 버퍼에 쌓아 두는 것과 동시에 이미 쌓인 데이터를 순차적으로 커내서 처리한다. 이때 만약 수신측 컴퓨터의 성능이 낮다면 데이터가 들어오는속도보다 처리하는 속도가 느려져 문제가발생할 수 있다. 그래서 수신측은 응답을 보낼때 윈도우 사이즈를 설정하여 현재 어느 정도까지 수신할 수 있는지를 수시로 알려주게 된다. 이런과정을 흐름제어라고 한다. (flow control)
버퍼가 가득 차면 윈도우 사이즈가 0으로 설정되고 데이터 전송은 일단 멈추게 된다. 다시 전송을 재개할 시점을 알기 위해서 송신측은 탐색패킷혹은 윈도우 프로브(window probe)라고 하는 패킷을 수신측에 보내고 수신측의 응답을 받아 현재 윈도우사이즈를 확인한 후 전송 재개 여부를 결정한다.
버퍼에 빈 공간이 있다고 하더라도 네트워크 경로가 혼잡한 상태라면 통신 속도를 낮춰야한다. 이때 인터넷 계층의 헤더 안에 혼잡 플래그가 On으로 설정되고, 송수신 측양쪽이 ECE플래그와 CWR플래그를 사용해서 통신 속도를 조절하게 된다.
일련번호와 확인 응답번호를 사용해서 재전송 여부를 확인하는 경우, 패킷 누락이 발생하면 누락된 이후의 모든 패킷을 재전송해야한다. 이때 누락된 패킷만 재전송 하는 방법도있는데, 이것을 선택적 확인 응답(SACK,Selective Acknowledgment)이라고 하고 송수신 측 모두 이것을 지원해야 사용할 수 있다.

## UDP가 고속으로 데이터를 전달하는 법

UDP(User Datagram Protocol)는 TCP에 비해 상당히 간단한 프로토콜로서 단순히 데이터를 보내는 역할만 한다. 통신 과정에서 데이터의 손실이 발생할 수 있는데, VoIP와 같은 음성 서비스나 동영상 스트리밍 서비스는 일부 데이터가 누락되거나 외곡되더라도 큰 문제가 없기 때문에 UDP를 주로 사용한다.
접속이 맺어졌는지 확인하지 않고 바로 송신, 패킷이 도중에 손실되도 상관x , 데이터가 조금 누락되더라도 제때 빠르게 전송되어야 하는 상황에서 사용된다.
TCP에는 없는 기능으로 UDP에는 하나의 패킷을 여러 수신지에 전달하는 브로드캐스트와 멀티캐스트라는 기능이 있다. 특히 브로드캐스트는 파일공유나 DHCP와 같이 네트워크 내의 여러 컴퓨터나 통신 장비와 정보를 교환할 때 사용된다.
실시간 처리가 필요한 온라인 게임에서는 전송속도가 우선인 UDP를 사용하긴 하지만, 데이터 전송의 신뢰성 역시 속도에 못지않게 중요하다. 이런 경우에는 애플리케이션 계층에서 흐름제어나 혼잡제어를 구현해서 부족한 신뢰성을 보완하게 된다. (UDP를 애플리케이션 계층으로 둘러싼다.)

## netstat 명령으로 네트워크의 상태 확인하기

netstat명령을 실행한다. TCP나 UDP는 웹브라우저와 같은 애플리케이션 뒤에서 백그라운드로 동작하기 때문에 사용자가 직접 육안으로 확인 가능한 결과를 출력하지는 않는다. 다만 netstat명령으로 접속 상태를 확인하는 것은 가능한데, IP어드레스나 프로토콜, 포트번호등의 목록을 주회할 수 있다. 프롬프트를 실행하고서 'netstat -n' 을 입력한다. netstat가 명령어이고 -n은 옵션이다. -n은 IP어드레스와 포트번호를 숫자로 표시하라는 의미인데 이 옵션을 주지 않으면 호스트명과 프로토콜 이름을 조합한 형태로 표시한다.
상태 값의 의미
ESTABLISHED: TCP접속이 맺어져 통신이 이루어지고있는 상태
LISTEN: 서버가 수신 대기 상태이다. -a옵션을 통해 확인가능하다.
TIME_WAIT: 접속을 종료하려는 중이다.
HTTP나 HTTPS는 상태 정보를 저장하지 않는 스테이트리스 프로토콜이기때문에 응답을 한 번씩 주고받으면 통신이 바로 종료되어 상태를 확인하기 어렵다. 그래서 통신중인 상태를 확인하기 위해 일부러 종료하기 전까지는 통신이 끊어지지 않는 FTP로 시험을 해 보기로 하자.
FTP클라이언트로 사이버덕을 실행한 후에 FTP서버에 접속하고 netstat 명령을 실행하면 21번 포트(FTP의 컨트롤 커넥션)로 통신 중인것을 확인 할수 있다.

## 패킷 캡처 도구

netstat명령은 간단한 통신 상태만 확인 할 수 있다. 네트워크 통신 상태를 보다 더 상세하게 살펴보고 싶다면 통신중인 패킷을 실시간으로 확인할 수 있는 패킷 캡처 도구를 사용하면 된다. 패킷 캡처도구에는 소프트웨어나 하드웨어등 여러 형태로 만들어진 것들이 있다.
