# 4장 라우팅과 인터넷 계층

인터넷 계층의 역할은 송신지 컴퓨터의 데이터를 수신지 컴퓨터까지 전달하는 것이다.
인터넷에는 수많은 컴퓨터가 연결되어 있기 때문에 수신지 컴퓨터를 정확하게 찾아내기 위해서는 고유 식별자가 필요하다. 이때 사용되는 식별자가 바로 IP어드레스이다.
IP어드레스는 흔히 우편번호나 전화번호로 비유되는데, 수신지의 정보를 표현한다는 측면에서는 비슷하지만 차이점이 분명 존재한다. 우편번호의 앞 세자리는 특별시, 도와 시, 군, 자치구를 의미하는데, 예를 들어 앞자리가 108로 시작하면 경기도 파주시에 해당한다. 전화번호의 지역번호는 앞 세자리가 지역을 의미하는데, 예를 들어 031이라면 경기도에 해당한다. 이렇게 우편번호와 전화번호가 지역정보를 포함하는 것과 달리 IP어드레스는 지리적인 위치와는 상관없이 네트워크 단위로 할당된다. 그래서 IP어드레스를 보면 그 컴퓨터가 어느 지역에 있느냐를 알수 있는 것이 아니라 어느 네트워크에 속해 있느냐를 알수 있고, 소속된 네트워크의 규모도 짐작할 수 있다. IP어드레스를 할당받을 때 발급 기관이나 할당받은 조직이 어느 정도 지리적인 범위 내에 있으므로 큰 범위에서의 유추 정도는 가능하다. 다만 IP어드레스는 지역별로 할당되지 않고 네트워크 단위로 할당되기 때문에 엄밀하게는 지역 정보를 포함하지 않는다고 보는 것이 정확하다.
IP어드레스에는 지리적인 위치 정보가 포함되어 있지 않다. 데이터가 전달될 수신지를 찾기 위해서는 우편번호나 전화번호와는 다른 방법을 사용해야 한다. 라우터라는 네트워크 장비는 하나의 네트워크가 또 다른 네트워크와 연결되어 있다는 것과 같이 네트워크 간의 연결 정보를 관리한다. IP 어드레스를 보면 소속된 네트워크가 어딘지 알수 있는데, 해당 네트워크에 연결된 라우터를 추적하다 보면 그 장비가 최종적으로는 목표로 한 수신지 컴퓨터를 찾게 되고 송신지에서 수신지까지 연결되는 통신 경로를 만들수 있게된다. 단, 인터넷 계층이 데이터를 전달하는 방식은 지리적인 위치나 거리와는 상관이 없기 때문에 물리적으로는 가까운 거리에 있음에도 불구하고 네트워크 간의 연결 구조상 통신 경로가 멀리 우회해서 간다거나, 반대로 네트워크간의 연결 구조는 가까우나 실제로는 바다를 건널 정도로 지리적으로 멀리 떨어져 있을 수도 있다.

## 인터넷 계층의 역할

인터넷 계층의 프로토콜은 수신지 컴퓨터가 아무리 멀리 있더라도 데이터를 전달할 수 있도록 설계되어있다.
IP어드레스 정보를 보고 데이터를 전달한다.
인터넷 계층은 네트워크 인터페이스 계층과 협력하여 다른 컴퓨터에게 데이터를 전달하는 역할을 한다. 하드웨어에 의존해야 하는 부분은 네트워크 인터페이스 계층이 담당하고, 인터넷 계층은 IP어드레스라고 하는 식별자 정보를 실마리로 데이터를 전달할 수 있는 체계를 제공하도록 역할이 각각 구분되어있다.
데이터를 목적지까지 전달하기 위해서는 라우터라고 하는 네트워크 장비가 필요하다. 라우터는 네트워크와 네트워크를 연결하는 역할을 하는데, 하나의 라우터는 데이터를 목적지까지 전달하기 위해다음 네트워크의 경로를 찾고, 그 경로상에 있는 라우터에게 데이터 전달을 위임한다.이런 과정은 최종 목적지를 찾기까지 연쇄적으로 반복되는데, 이렇게 라우터가 목적지의 경로를 찾아 나가는 과정을 라우팅(routing)이라고 한다.라우터가 자신이 속한 네트워크에 목적지 컴퓨터가 속해 있다면 그 컴퓨터에게 데이터를 전달한다.
인터넷 보급이 급속도로 확산됨에 따라 사용 가능한 IP어드레스는 점점 줄고 있다. 그래서 IP어드레스의 고갈을 방지하기 위한 대안으로 프라이빗 어드레스와 퍼블릭어드레스를 구분하는 기법을 사용한다. 한편 근본적인 방법으로는 IPv4보다 주소 체계가 확장된IPv6의 도입이 가속화 되고있다. 그 외에도 IP어드레스와 관련된 기술로는 숫자로 된 IP어드레스를 사람이 알아보기 쉬운 도메인명과 연결해 주는DNS등이 있다.

## IPv4와 IPv6

IPv4와 IPv6는 인터넷 계층에서 사용되는 중요한 프로토콜로, IP어드레스를 결정할 때 사용하는 비트의 길이가 서로 다르다. IPv4는 현재까지 컴퓨터의 어드레스를 지정할 때 가장 많이 사용되는 인터넷 계층의 프로토콜이다. 네트워크에 연결된 컴퓨터를 식별하기 위해 32비트의 IP어드레스가 사용된다. 단,32비트 문자열은 사람이 알아보기 어렵기 때문에 전체 32비트를 8비트씩 4단위로 끊은 후에 10진수로 변환하여 표기하고 있다. 인터넷 계층에서 사용되는 장비에만IP어드레스가 할당된다. 여러 네트워크 장비들중 네트워크 허브와 같이 네트워크 인터페이스 계층에서 사용되는 장비들에는 IP어드레스가 할당되지 않는다. IPv4 패킷의 IP헤더에는 송신지와 수신지의 IP어드레스 외에도 패킷 길이와 같은 다양한 정보들이 들어있다. 트랜스포트 계층에서 전달받은 데이터에 IP헤더를 덧붙인다.
수신지로 지정된 컴퓨터가 실제로는 존재하지 않거나 통신 경로를 찾지 못해 패킷이 제대로 전달되지 않는 경우가 종종 발생할 수 있다. 이렇게 패킷이 목적지를 찾지못해 네트워크 안을 계속 떠돌게 되면 네트워크가 혼잡해질 수 있는데, 이러한 문제를 방지하기 위해 IPv4헤더에는 생존기간정보를 설정 할 수 있게 되어있고, 만약 생존기간을 초과한 패킷이 네트워크 상에서 발견되면 그 패킷을 소멸시키도록 규정하고 있다.
한번에 전송할 수 있는 데이터 크기를 MTU(Maximum Transmission Unit)이라고 하고, 이 값은 통신경로의 상태에 따라 달라진다. 예를 들어, 경로 상태가 좋지 않으면 이 값이 줄어들게 되는데, 라우터에는 이 MTU 값에 따라 패킷을 분할해서 전송하는 기능이 구현되어 있다. 다만 라우터의 작업 부하가 높아지거나 분할된 패킷 중의 일부가 유실되면 복원이 어려워지는 단점이 있다. 그래서 라우터가 데이터를 송신히기 전에 통신경로 전체의 MTU를 살펴본후 처음부터 MTU보다 작은 크기의 패킷을 만들도록 설정하기도 한다.
인터넷의 급격한 성장으로 인해 IPv4의 32비트 어드레스가 머지않아 고갈될 상황에 이르렀다.
IPv6 어드레스의 길이는 128비트이고, 2의 128승개, 즉 약 340간개의 장비들을 식별할 수 있다.
IPv6 와 IPv4는 어드레스나 패킷 어느것으로도 서로 호환이 되지 않는다. 그래서 현재는 여러 다양한 기법을 사용해서 두가지를 병행할 수 있도록 만드는 등 IPv6로 이행하기 위한 노력이 계속되고있다. 하나의 장비에 두 종류의 어드레스를 할당한 후 둘다 사용 가능하도록 만드는 것은 듀얼 스택이라고 한다. Ipv4네트워크를 지나갈 때는 Ipv4패킷안에 Ipv6패킷을 채워서 보내는 것을 터널링이라고 한다.

## IP 어드레스의 활용

IP어드레스는 주소 할당 방법에 따라 네트워크 부와 호스트부로 나뉘어지고, 해당 주소에 대한 접근 범위에 따라 프라이빗 어드레스와 퍼블릭 어드레스로 나뉜다.
IP어드레스는 네트워크부와 호스트부로 구성된다. 여기서 말하는 호스트는 네트워크에 연결된 컴퓨터나 네트워크 장비를 의미한다. 라우터는 송신지 IP어드레스의 네트워크 부의 정보를 보고 데이터를 송신할 목적지가 같은 네트워크 안에 있는지 다른 네트워크에 있는지를 판단하게 된다.(IP어드레스는 네트워크를 표현하는 부분과 그 네트워크에 속한 호스트를 표현하는 부분으로 구성된다.)
어디까지가 네트워크 부인가? '네트워크'라는 용어는 여러 컴퓨터가 연결되어 데이터를 주고받을 수 있는 것을 의미하는 광의의 개념이다. 그래서 가정이나 사무실내의 LAN은 물론 인터넷 전체도 네트워크에 해당한다. 단, 인터넷 계층을 설명할 때 사용되는 네트워크라는 단어의 의미는 IP어드레스의 네트워크 부가 같은 컴퓨터의 그룹 정도의 좁은 의미로 이해하면 된다. 그래서 네트워크 부가 다르다는 말은 그 네트워크는 서로 다른 네트워크라는 의미가되고, 라우터와 같은 장비를 통하지 않고서는 각 네트워크가 서로 연결되지 않는다는 것을 의미한다.
하나의 IP어드레스 안에서 어디까지가 네트워크 부이고 어디까지가 호스트 부인지 미리 그 길이를 고정하여 결정해 둔 것이 있는데, 이것을 어드레스 클래스라고 부른다. 클래스 A의 어드레스는 한개의 네트워크당 약 1677만 대의 호스트의 어드레스를 할당 할 수 있다. 하지만 실제로는 그렇게 많은 호스트를 하나의네트워크에 연결하는 경우는 거의 없기 때문에 많은 수의 어드레스가 사용되지 않고 그냥 낭비된다. 어드레스 클래스를 사용한 네트워크를 좀더 세분화할 수 있는데 이때 사용하는 것이 서브넷 마스크이다.
어드레스 클래스는 네트워크 부의 길이가 미리 정해져 있다. 하지만 서브넷 마스크를 사용하면 이 길이를 비트 단위로 유연하게 늘려서 쓰는 것이 가능하다. 서브넷 마스크는 IP어드레스에 추가되는 정보이므로 32비트 길이만큼의 정보가 더 필요하다. IP어드레스는 네트워크 상에서 호스트(컴퓨터나 라우터 같은 장비)를 식별하기 위해 사용되는데, 전체 32비트 중 네트워크 부를 제외한 호스트 부 부분만 자유롭게 할당하여 사용할 수 있다.
서브넷 마스크를 사용하면 네트워크를 더 세분화하여 서브네트워크, 즉 서브넷을 만들 수 있다. 한 네트워크에 연결하고 싶은 호스트들의 규모에 맞게 적절히 서브넷을 구성하면 부서나 지사, 지역 단위와 같이 작은 네트워크들을 만들어 네트워크 운영을 보다 유연하고 효과적으로 할 수 있다.
서브넷 마스크의 한계
서브넷 마스크는 어드레스 클래스에서 미리 정해진 네트워크 부의 길이를 더 늘일 수는 있지만 더 줄이지는 못한다. 그래서 이미 호스트 길이가 짧게 만들어진 클래스 C인경우, 남은 8비트내에서 서브넷 부와 호스트부로 나누게 되므로 실제로 할당할 수 있는 호스트 대수가 급격히 줄어든다. 그 결과 클래스 C에서는 서브넷을 사용하는 것이 도움이 안된다. 그래서 서브넷을 도입하는 경우는 호스트부가 긴 클래스 A나 클래스 B의 어드레스를 세분화해야 할 때 사용하는 것이 일반적이다.
프라이빗 IP어드레스는 가정이나 사내에서 자유롭게 사용할 수 있는 어드레스다. 인터넷이나 다른 네트워크에 연결되지 않아서 주소가 충돌만 나지 않는다면 다른 네트워크에서 사용중인 어드레스를 사용한다해도 큰 문제는 없다. 다만 프라이빗 IP어드레스는 인터넷에 연결해도 외부에서 접근할 수 없기 때문에 NAT(Network Address Translation)와 같은 어드레스 변환 기술을 사용해서 퍼블릭 IP어드레스로 변환해 주는 기법이 필요하다. 프라이빗 IP어드레스는 같은 네트워크 안에서 중복만 되지 않으면 된다. 라우터는 프라이빗 IP어드레스와 퍼블릭 IP어드레스를 둘다 가지고 있다.
퍼블릭 IP어드레스는 인터넷 안에서 중복되면 안되기 때문에 ICANN(Internet Corporation for Assigned Names and Numbers)이나 KRNIC(KOREA Network Information Center)와 같은 단체(인터넷 레지스트리)가 관리하고 있다. 퍼블릭 IP어드레스가 필요할 경우 각 단체에 신청해서 할당 받아야 한다.
퍼블릭 IP는 인터넷 레지스트리를 통해 인터넷 서비스 제공자들에게 할당되고 기업이나 가정은 인터넷 서비스 제공자가 확보한 IP어드레스를 빌려서 쓴다.
IP어드레스 중에는 이미 예약된 특수 목적의 어드레스가있다. 127.0.0.1은 루프백 어드레스(loopback address)혹은 로컬 호스트라고 부르는데, 호스트 자신을 가리킨다. 그 외에도 호스트부의 비트를 모두 1로 설정한 어드레스는 해당 네트워크의 모든 호스트들을 의미하는 브로드캐스트 어드레스가 된다. 또한, 호스트 부의 비트가 모두 0으로 설정된 경우는 네트워크 전체를 의미하는 어드레스가 된다.

## 라우팅이란?

데이터를 목적지의 IP어드레스까지 전달하려면 라우팅이라고 하는 경로 탐색 과정이 필요하다.
인터넷에서 데이터가 목적지까지 제대로 전달되기 위해서는 라우터가 자신과 연결된 다른 라우터를 찾아다니면서 최종 목적지까지 연결되는 경로를 찾을 수 있어야한다. 이러한 과정을 라우팅이라고하고, 이때 찾은 최적의 경로를 사용해서 통신을 하게 된다. 만약 통신 경로상에 장애가 발생하면 다음 차선책의 통신경로를 사용하여 통신을 재개한다.

데이터가 전송될 경로를 찾기위해서 네트워크상의 각 라우터는 서로 누구와 연결되어 있는지에 대한 정보를 교환한다. 이때 라우팅 프로토콜이 사용되는데 대표적인 것으로는 BGP, OSPF,RIP등이 있다.
라우터끼리 누구랑 연결되어 있는지 정보를 교환한후 경로 정보를 만들어낸다.
인터넷 서비스 제공자가 사용하는 규모가 큰 네트워크에서는 몇개의 네트워크를 하나로 묶어 자율시스템이라는 단위로 관리한다.네트워크의 경로 하나하나를 찾아다니면서 이동하는 대신, AS와 같이 큰 덩어리의 접속 경로 단위로 이동하면 멀리 있는 컴퓨터와도 더 빠른 속도로 통신할 수 있다.
라우터는 목적지 네트워크를 포함한 AS까지의 통신 경로를 찾는다.

## 라우터와 라우팅 프로토콜

라우터의 역할은 네트워크간 패킷을 전달하는 것이다. 이때 연결하고 있는 각 네트워크에서 사용하는 IP어드레스가 각각 하나씩 필요하며, 결과적으로 연결한 네트워크 개수만큼의 IP어드레스를 여러개 가지게 된다.
가정에서 사용되는 초고속 인터넷 라우터도 주택내의 네트워크에서 사용하는 IP어드레스와 인터넷 서비스 제공자의 네트워크에서 사용되는 IP어드레스 각각을 가지고 있다.단, 라우팅 기능은 경량화되어 있는데, 외부로 전달되어야하는 패킷은 별도의 복잡한 처리없이 바로 인터넷 서비스 제공자 측의 라우터로 전달 되도록 되어있다.
라우터는 내부에 저장하고 있는 라우팅 테이블이라는 정보를 활용하여 라우팅을 한다. 라우팅 테이블에는 목적지 호스트가 속한 네트워크 정보와 그 네트워크로 도달하기 위해 경유해야하는 라우터의 정보가 들어있다.
라우팅 테이블은 고속도로의 도로안내 표지처럼 목적지에 도착하기 위해서는 어느 방향으로 가야 하는 지 알려주는 역할을 한다.
라우팅 테이블을 만드는 방법은 크게 두가지가 있는데, 네트워크 관리자가 직접 수작업으로 라우팅 테이블을 설정하는 방식을 정적 라우팅이라고하고, 라우팅 프로토콜을 사용하여 자동적으로 경로 정보를 수집한후 라우팅 테이블을 설정하는 방식을 동적 라우팅이라고 한다. 네트워크간의 접속형태가 복잡하면 정적 라우팅으로 설정하는 것이 사실상 불가능하기 때문에 대부분 동적 라우팅을 사용한다.
인터넷에는 수많은 네트워크가 연결되어 있기 때문에 모든 네트워크의 통신 경로를 저장하는 것은 사실상 불가능하다. 그래서 한라우터의 라우팅 테이블에는 목적지의 정보가 없다면 해당 라우터보다 더 많은 정보를 가지고 있는 기본 라우터 혹은 디폴트라우터에게 물어보게 된다. 이 디폴트 라우터 정보는 각 라우터마다 정적으로 설정되어 있다.
라우팅 프로토콜에는 여러 종류가 있는데, 경로를 찾는 방식에 따라 크게 거리벡터형, 링크 상태형의 두가지가 많이 사용된다. 이들 위에 자율 시스템 AS간의 통신에서 사용되는 경로벡터형도 있다.
RIP(Routing Information Protocol)프로토콜이 사용하는 방식은 거리벡터형이다. 목적지 까지의 거리를 살펴보고 짧은 경로를 선택하는 방식이다. 이때 거리는 경유하는 라우터의 수를 의미하는 홉의 수로 센다. 이 방식은 비교적 구성이 간단한 LAN네트워크에 적합하다.
OSPF(Open Shortest Path First)프로토콜이 사용하는 방식은 링크 상태형이다. 네트워크의 통신 상태 정보를 map으로 관리하면서 상태가 가장 좋은 경로를 선택한다. 복잡하고 변화가 잦은 네트워크 구성에 적합하다.
자율 시스템(AS)안에서는 주로 링크 상태형인 OSPF를 사용한다. 다만 링크 상태형은 네트워크 규모가 커지면 맵 정보를 처리하는 부하가 커질 수 있다. 따라서 네트워크를 몇개의 영역으로 분할한 후 각 영역별로 맵을 따로 만드는 방식을 사용한다.
접속 확인을 하고 경로 정보를 서로 교환하면서 모든 라우터가 같은 맵 정보를 가지도록 한다.
정기적으로 접속 확인을 하여 응답이 없는 라우터가 발견될 경우 접속 정보를 갱신하여 주변 라우터에게 통보한다. AS끼리는 경로 벡터형인 BGP(Border Gateway Protocol)가 사용된다. 경로 벡터형은 경로의 거리 뿐 아니라 경로 도중에 경유하는 AS정보도 포함되어 경로 정보를 만든다.
AS에는 IP어드레스처럼 16비트혹은 32 비트의 길이로 AS번호가 할당된다. AS번호는 퍼블릭 AS번호와 프라이빗 AS번호로 나누어지고, 퍼블릭 AS번호는 퍼블릭 IP어드레스와 마찬가지로 전세계적으로 중복되지 않도록 관리되고 있다. 퍼블릭 IP를 할당받기 위해서는 KRNIC과 같은 인터넷 레지스트리에 신청하면 된다.
