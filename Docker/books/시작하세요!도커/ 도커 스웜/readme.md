# 3 도커 스웜

## 3.1 도커 스웜을 사용하는 이융

지금까지 알아본 도커 사용법은 대부분 하나의 호스트를 기준으로한다. docker ps 명령어는 하나의 도커 엔진에 존재하는 컨테이너의 목록을 출력하며 create, run 명령어 또한 하나의 도커 엔진에 컨테이너를 생성한다. 그러나 실제로 도커를 운영환경에 적용한다면 이야기가 달라진다. 하나의 호스트 머신에서 도커엔진을 구동하다가 CPU나메모리, 디스크 용량과 같은 자원이 부족하면 이를 어떻게 해결할까?

서버 클러스터링에 관심이 있지만 가격과성능 등의 문제로 여러대의 서버를 사용하지 못하고 있다면 라즈베리 파이같은 저렴한 가격의 하드웨어를 여러개 사거나 각종 클라우드 서비스에서 서버 인스턴스를 최소한의 성능으로 제공받아 도커 클러스터를 구축하는 것도 좋은 선택이 될 수 있다.

그러나 여러대의 서버를 하나의 자원 풀로 만드는 것은 쉬운 작업이 아니다. 새로운 서버나 컨테이너가 추가되었을 때 이를 발견 하는 작업부터 어떤 서버에 컨테이너를 할당할 것인가에대한 스케줄러와 로드밸런서 문제, 클러스터 내의 서버가 다운됐을때 고가용성을 어떻게 보장할지 등이 문제로 남아있다. 

## 3.2 도커 스웜과 도커 스웜 모드

도커 스웜과 스웜모드는 여러대의 도커 서버를 하나의 클러스터로 만들어 컨테이너를 생성하는 여러 기능을 제공한다. 다양한 전략을 세워 컨테이너를 특정 도커 서버에 할당할 수 있고 유동적으로 서버를 확장할 수 있다. 그뿐만아니라 스웜 클러스터에 등록된 서버의 컨테이너를 쉽게 관리할수도있다. 이러한우수한 기능 덕분에 많은 이들이 도커 스웜과 스웜모드를 사용하고 있다. PaaS와 같은 용도로 도커 서버 클러스터링을 고려하고 있다면 가장 먼저 스웜을 사용해보길 권한다.

여러개의 도커 서버를 하나의 클러스터로 구성하려면 각종 정보를 저장하고 동기화하는 분산 코디네이터, 클러스터 내의 서버를 관리하고 제어하는 매니저, 각 서버를 제어하는 에이전트가 반드시 필요하다. 이는 도커 클러스터 뿐 아니라 대부분 서버 클러스터링 기술에서 사용되는 구조이며, 여러개의 서버를 통합해 관리하기 위해서는 필수 불가결한 구조이다. 
도커 스웜과 스웜모드의 차이점중 하나는 스웜 에이전트와 분산 코디네이터가 도커 자체에 내장되어있느냐 또는 별도로 구동되느냐입니다. 스웜모드는 에이전트가 도커 자체에 내장돼있어 이를 별도로 설치할 필요가없으며 외부에 분산 코디네이터를 설치할 필요도없다. 따라서 스웜보드가 스웜에 비해 사용이 쉽고 간편하다. 즉 스웜은 도커를 제어하기 위한 에이전트가 컨테이너로서 존재하며 분산 코디네이터 또한 외부에 별도로 존재해야 한다는 점이 클러스터 구축의 차이점이다.

분산 코디네이터는 클러스터에 영입할 새로운 서버의 발견, 클러스터의 각종 설정 저장, 데이터 동기화 등에 주로 이용된다. etcd, zookeeper,consul등이 대표적인 예이며 , 스웜은 대부분의 분산 코디네이터를 사용할 수 있다. 

도커 스웜과 스웜모드의 가장 큰 차이점은 바로 그 목적에 있다. 도커 스웜은 여러대의 도커 서버를 하나의 지점에서 사용하도록 단일 접근점을 제공한다면 스웜모드는 웹서비스 컨테이너를 다루기 위한 클러스링 기능에 초점을 맞추고 있다. 도커 스웜으니 docker run, docker ps등 일반적인 도커 명령어로 클러스터의 서버를 제어하고 관리할 수 있는 기능을 제공한다. 이에비해 스웜모드는 같은 컨테이너를 동시에 여러개 생성해 필요에 따라 유동적으로 컨테이너의 수를 조절할 수 있으며, 컨테이너로의 연결을 분산하는 로드밸런싱 기능을 자체적으로 지원한다.

## 3.3 도커 스웜모드

스웜모드는 매니저 노드와 워커 노드로 구성돼 있다. 워커노드는 실제로 컨테이너가 생성되고 관리되는 도커 서버이고 매니저 노드는 워커노드를 관리하기 위한 도커서버이다. 그렇지만 매니저 노드에도 컨테이너가 생성될 수 있다. 즉 매니저 노드는 기본적으로 워커노드의 역할도 포함한다.매니저 노드는 1개이상이 있어야하지만 워커 노드는 없을 수도 있다. 이는 매니저 노드가 워커 노드의 역할도 포함하고 있어 매니저 노드만으로 스웜 클러스터를 구성할 수 있기 때문이다.

스웜 매니저는 홀수개로 구성하는게 바람직하다. 스웜 모드는 매니저 노드의 절반 이상에 장애가 생겨 정상적으로 작동하지 못할 경우 장애가 생긴 매니저 노드가 복구될 때까지 클러스터의 운영을 중단한다. 이때 매니저 노드의 개수를 홀수로 구성하면 짝수로 구성했을 때보다 매니저 노드의 장애를 더 허용할 수 있으며 매니저 노드 사이에 데이터 일관성을 유지할 수 있다.

스웜 매니저는 기본적으로 2377번 포트를 사용하며, 스웜이 사용하는 네트워크인 ingress 오버레이 네트워크에 4789 포트를 사용한다. 스웜 클러스터를 구성하기 전에 이러한 포트를 각 호스트 머신에 열어두어야한다. 

매니저 노드는 일반적인 매니저 역할을 하는 노드와 리더 역할을 하는 노드로 나뉜다. 리더 매니저는 모든 매니저 노드에 대한 데이터 동기화와 관리를 담당하므로 항상 작동할 수 있는 상태이어야한다. 리더 매니저의 서버가 다운되는 등의 장애가 생기면 매니저는 새로운 리더를 선출하는데, 이때 Raft Consensus 알고리즘을 사용한다. 

### 3.3.3 스웜 모드 서비스

도커 명령어의 제어 단위는 컨테이너이다. docker run 명령어는 컨테이너를 생성하고 docker rm 명령어는 컨테이너를 삭제했던 것처럼 도커 클라이언트에서 사용하는 명령어가 제어하는 것은 컨테이너이다. 그러나 스웜모드에서 제어하는 단위는 컨테이너가 아닌 서비스이다. 

서비스는 같은 이미지에서 생성된 컨테이너의 집합이며, 서비스를 제어하면 해당 서비스 내의 컨테이너에 같은 명령이 수행된다. 서비스내의 컨테이너 1개 이상 존재할 수 있으며, 컨테이너들은 각 워커 노드와 매니저 노드에 할당된다. 이러한 컨테이너들을 태스크라고한다. 서비스는 롤링 업데이트 기능도 제공한다. 서비스 내 컨테이너 들의 이미지를 일괄적으로 업데이트 해야할 때 컨테이너들의 이미지를 순서대로 변경해 서비스 자체가 다운되는 시간 없이 컨테이너의 업데이트를 진행할 수 있다. 롤링 업데이트는 여러개의 서버 컨테이너등으로 구성된 클러스터의 설정이나 데이터 등을 변경하기 위해 하나씩 재시작하는 것을 의미한다. 롤링 업데이트를 사용하지 않고 모든 서버나 컨테이너를 한번에 재시작하면 제공하는 서비스에 다운시간이 생기지만 롤링 업데이트를 이용하면 하나를 업데이트해도 다른 서버나 컨테이너는 작동중이기 때문에 지속적인 서비스가 가능하다.

서비스르 ㄹ제어하는 도커 명령어는 전부 매니저 노드에서만 사용할 수 있다. 서비스를 사용하기 위한 명령어는 docker service 로 시작한다 . 서비스를 생성하려면 docker service create 명령어를 사용한다.


docker service create 명령어도 run 명령어와 비슷한 형식을 띈다. 

```
docker service create ubuntu:14.04 /bin/sh -c "while true; do echo hello world; sleep 1; done"
```

서비스 내의 컨테이너는 detached 모드로, docker run 명령어의 -d 옵션을 사용해 동작할 수 있는 이미지를 사용해야한다. 

서비스를 생성했다면, 서비스의 목록을 확인해 방금 생성한 서비스가 정상적으로 구동하고 있는지 확인한다. 스웜 클러스터 내의 서비스 목록은 docker service ls 명령어로 확인할 수 있다. run 명령어를 사용했을 때처럼 서비스의 이름을 따로 정의하지 않았기 때문에 서비스의 이름이 무작위로 설정된다.

서비스의 자세한 정보를 보려면  docker service ps [service name] 과 같이 입력한다. 

스웜노드는 라운드 로빈 방식으로 서비스 ㅐㄴ에 접근할 컨테이너를 결정한다. 각 노드의 트래픽이나 자원 사용량등을 고려해 로드밸런싱해야한다면 이방식은 적합하지 않을 수 있다. 

global 서비스 생성하기

서비스의 모드는 두가지가 있다. nginx 웹서버 서비스와 같이 레플리카 셋의 수를 정의해 그만큼의 같은 컨테이너를 생성하는 복제모드로서 실제서비스를 제공하기 위해 일반적으로 쓰이는 모드이다. 

다른 하나는 글로벌 모드이다. 글로벌 서비스는 스웜 클러스터 내에서 사용할 수 있는 모든 노드에 컨테이너를 반드시 하나씩 생성한다. 따라서 글로벌 모드로 생성한 서비스는 레플리카 셋의 수를 별도로 지정하지 않는다 . 글로벌 서비스는 다음과 같이 docker service create 명령어에 --mode global 를 추가해 생성한다. 


#### 3.3.3.4 서비스 롤링 업데이트

스웜 모드는 롤링 업데이트를 자체적으로 지원하며 매우 간단하게 사용할 수 있다. 우선 롤링 업데이트를 테스트하기 위한 서비스를 생성한다. 이 서비스는 앞에서 생성한 서비스와 유시하지만 이번에는 컨테이너 생성에 사용될 이미지를  nginx:1.10으로 설정한다.

```
docker service create --name myweb --replicas 3 nginx:1.10
```

docker service ps 명령어에서 NAME 항목에 \_가 붙어있는 컨테이너는 어떠한 이유로든 동작을 멈춘 컨테이너로서 서비스에서의 컨테이너 변경 기록을 나타낸다.

서비스를 생성할 때 롤링 업데이트 주기 업데이트를 동시에 진행할 컨테이너의 개수 업데이트에 실패했을 때 어떻게 할 것인지를 설정할 수 있다. 

```
docker service create \
--replicas 4 \
--name myweb3 \
--update-delay 10s \
--update-parallelism \
nginx:1.10
```

위와 같은 서비스의 롤링 업데이트 설정은 docer service inspect 으로 확인가능하다. 

#### 3.3.3.5 도커 스웜 네트워크

